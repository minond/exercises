<!DOCTYPE html>
<html>
<head>
  <title>Green Screen!</title>
  <script src="https://www.dukelearntoprogram.com/course1/common/js/image/SimpleImage.js"></script>
  <script>
  var foregroundImage;
  var backgroundImage;

  function saveForeground() {
    var canvas = document.getElementById("foregroundOut");
    var input = document.getElementById("foregroundIn");
    foregroundImage = new SimpleImage(input);
    foregroundImage.drawTo(canvas);
  }

  function saveBackground() {
    var canvas = document.getElementById("backgroundOut");
    var input = document.getElementById("backgroundIn");
    backgroundImage = new SimpleImage(input);
    backgroundImage.drawTo(canvas);
  }

  function createComposite() {
    if (foregroundImage == null || !foregroundImage.complete()) {
      alert("foreground image is not loaded yet.");
      return;
    }

    if (backgroundImage == null || !backgroundImage.complete()) {
      alert("background image is not loaded yet.");
      return;
    }

    var width = foregroundImage.getWidth();
    var height = foregroundImage.getHeight();

    var output = new SimpleImage(width, height);

    for (var p of foregroundImage.values()) {
      var x = p.getX();
      var y = p.getY();
      if (p.getGreen() > p.getRed() + p.getBlue()) {
        var bgPixel = backgroundImage.getPixel(x, y)
        output.setPixel(x, y, bgPixel);
      } else {
        output.setPixel(x, y, p);
      }
    }

    clearCanvases();
    var canvas = document.getElementById("foregroundOut");
    output.drawTo(canvas);
  }

  function clearCanvases() {
    var foreground = document.getElementById("foregroundOut");
    var background = document.getElementById("backgroundOut");

    foreground.width = 200;
    foreground.height = 100;
    background.width = 200;
    background.height = 100;

    foreground.getContext("2d")
      .clearRect(0, 0, foreground.width, foreground.height);

    background.getContext("2d")
      .clearRect(0, 0, background.width, background.height);
  }
  </script>
  <style>
  canvas {
    border: 1px dotted gray;
    margin: 10px 0;
    height: 250px;
    width: 500px;
  }
  </style>
</head>
<body>
<h2>Green Screen!</h2>

<div>
  Foreground: <input id="foregroundIn" type="file" multiple="false" accept="image/*" onchange="saveForeground()" />
</div>

<div>
  Background: <input id="backgroundIn" type="file" multiple="false" accept="image/*" onchange="saveBackground()" />
</div>

<input value="Create Composite" type="button" onclick="createComposite()" />
<input value="Clear" type="button" onclick="clearCanvases()" />

<div>
  <canvas id="foregroundOut"></canvas>
  <canvas id="backgroundOut"></canvas>
</div>
</body>
</html>
